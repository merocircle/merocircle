name: Promote Main to Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "release" to confirm production deployment'
        required: true
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest

    steps:
      - name: Confirm release intent
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "release" ]; then
            echo "âŒ Release not confirmed. You must type 'release'."
            exit 1
          fi
          echo "âœ… Release confirmed."

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and merge release PR (main â†’ prod)
        run: |
          PR_URL=$(gh pr create --base prod --head main --title "Release: main to prod" --body "Automated release from workflow run" 2>/dev/null || true)
          if [ -z "$PR_URL" ]; then
            PR_URL=$(gh pr list --base prod --head main --state open --json number,url -q '.[0].url' 2>/dev/null || true)
          fi
          if [ -n "$PR_URL" ]; then
            echo "Merging PR: $PR_URL"
            gh pr merge "$PR_URL" --merge --delete-branch=false
          else
            echo "No PR to merge (main may already be up to date with prod)."
          fi

      - name: Create and push release tag
        run: |
          git fetch origin prod
          VERSION="v$(date +'%Y.%m.%d.%H%M')"
          git tag "$VERSION" origin/prod
          git push origin "$VERSION"
          echo "ðŸ“¦ Created tag $VERSION"
